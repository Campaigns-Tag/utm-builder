<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    :root {
      /* Lone Wolf Aesthetic */
      --background: #0a0a0a;
      --foreground: #b0bccc;
      --card: #121212;
      --primary: #fafafa;
      --primary-foreground: #000000;
      --secondary: #7dd3fc;
      --secondary-foreground: #000000;
      --muted: #65758b;
      --border: #2b3648;
      --input: #2b3648;
      --ring: #7dd3fc;
      --destructive: #e11d48;
      --success: #188038;
    }

    body {
      font-family: 'Plus Jakarta Sans', 'Google Sans', Roboto, sans-serif;
      padding: 15px;
      color: var(--foreground);
      background-color: var(--background);
    }

    h2 {
      font-size: 1.25rem;
      margin-top: 0;
      color: var(--primary);
      letter-spacing: -0.025em;
    }

    .input-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--foreground);
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 0px;
      /* Aggressive Square */
      background-color: var(--card);
      color: var(--primary);
      box-sizing: border-box;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--ring);
      box-shadow: 0 0 8px rgba(125, 211, 252, 0.4);
    }

    input::placeholder {
      color: var(--muted);
    }

    .field-description {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .button-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 8px 16px;
      border: 1px solid transparent;
      border-radius: 0px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .primary-btn {
      background: var(--primary);
      color: var(--primary-foreground);
    }

    .primary-btn:hover {
      background: #e5e5e5;
      box-shadow: 0 0 10px rgba(250, 250, 250, 0.2);
    }

    .secondary-btn {
      background: transparent;
      color: var(--foreground);
      border: 1px solid var(--border);
    }

    .secondary-btn:hover {
      background: var(--card);
      border-color: var(--muted);
    }

    .secondary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #progress-container {
      margin-top: 20px;
      display: none;
    }

    .progress-bar-bg {
      width: 100%;
      height: 4px;
      background-color: var(--border);
      border-radius: 0px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: var(--secondary);
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 8px var(--secondary);
    }

    #status {
      font-size: 13px;
      font-weight: 500;
      color: var(--secondary);
    }

    .error-text {
      color: var(--destructive) !important;
      text-shadow: 0 0 8px rgba(225, 29, 72, 0.4);
    }

    .success-text {
      color: var(--success) !important;
    }

    .required-star {
      color: var(--secondary);
      text-shadow: 0 0 8px var(--secondary);
    }

    /* Advanced Tracking Toggle */
    .advanced-toggle-container {
      margin-top: 24px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .advanced-toggle-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--secondary);
      user-select: none;
      transition: color 0.2s;
    }

    .advanced-toggle-container:hover .advanced-toggle-text {
      color: #bae6fd;
      text-shadow: 0 0 8px rgba(125, 211, 252, 0.4);
    }

    .advanced-icon {
      margin-right: 8px;
      font-size: 10px;
      transition: transform 0.2s;
    }

    .advanced-panel {
      display: none;
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-left: 3px solid var(--secondary);
      margin-bottom: 20px;
    }

    .advanced-panel.active {
      display: block;
    }

    .platform-select {
      margin-bottom: 16px;
    }

    .template-container {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }

    .template-container.active {
      display: block;
    }

    .template-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .template-grid .input-group {
      margin-bottom: 0px;
    }

    .template-grid label {
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <h2>UTM URL Builder</h2>

  <div
    style="margin-bottom: 16px; padding: 12px; background: rgba(125, 211, 252, 0.05); border-left: 3px solid var(--secondary); font-size: 12px;">
    <strong>Instruction:</strong> Highlight the cells containing your base URLs in the sheet, then click Generate.
  </div>

  <div class="input-group" style="margin-bottom: 20px;">
    <label style="margin-bottom: 8px;">Generation Mode</label>
    <div style="display: flex; gap: 15px; font-size: 13px;">
      <label style="display: inline-flex; align-items: center; font-weight: 400; cursor: pointer;">
        <input type="radio" name="genMode" value="both" checked style="width: auto; margin: 0 6px 0 0;"> Both
      </label>
      <label style="display: inline-flex; align-items: center; font-weight: 400; cursor: pointer;">
        <input type="radio" name="genMode" value="utm" style="width: auto; margin: 0 6px 0 0;"> UTM Only
      </label>
      <label style="display: inline-flex; align-items: center; font-weight: 400; cursor: pointer;">
        <input type="radio" name="genMode" value="short" style="width: auto; margin: 0 6px 0 0;"> Shortener Only
      </label>
    </div>
  </div>

  <div class="input-group">
    <label>UTM Source <span class="required-star">*</span></label>
    <input type="text" id="utmSource" placeholder="e.g., google, newsletter">
  </div>

  <div class="input-group">
    <label>UTM Medium <span class="required-star">*</span></label>
    <input type="text" id="utmMedium" placeholder="e.g., cpc, email">
  </div>

  <div class="input-group">
    <label>UTM Campaign <span class="required-star">*</span></label>
    <input type="text" id="utmCampaign" placeholder="e.g., summer_sale">
  </div>

  <div class="input-group">
    <label>UTM Term (Optional)</label>
    <input type="text" id="utmTerm" placeholder="e.g., running+shoes">
  </div>

  <div class="input-group">
    <label>UTM Content (Optional)</label>
    <input type="text" id="utmContent" placeholder="e.g., logolink">
  </div>

  <!-- Advanced Tracking Section -->
  <div class="advanced-toggle-container" onclick="toggleAdvanced()">
    <span class="advanced-icon" id="advancedIcon">â–¶</span>
    <span class="advanced-toggle-text">Advanced Tracking (Ad Networks)</span>
  </div>

  <div class="advanced-panel" id="advancedPanel">
    <div class="input-group platform-select" style="margin-bottom:0px;">
      <label>Select Ad Platform</label>
      <select id="platformSelect" onchange="updateTemplates()">
        <option value="none">Standard / Custom</option>
        <option value="google">Google Ads (ValueTrack)</option>
        <option value="meta">Meta Ads (Facebook/IG)</option>
      </select>
    </div>

    <!-- Google Ads Inputs -->
    <div id="googleTemplate" class="template-container">
      <div class="template-grid">
        <div class="input-group"><label>campaignid</label><input type="text" id="g_campaignid" value="{campaignid}">
        </div>
        <div class="input-group"><label>adgroupid</label><input type="text" id="g_adgroupid" value="{adgroupid}"></div>
        <div class="input-group"><label>creative</label><input type="text" id="g_creative" value="{creative}"></div>
        <div class="input-group"><label>keyword</label><input type="text" id="g_keyword" value="{keyword}"></div>
        <div class="input-group"><label>matchtype</label><input type="text" id="g_matchtype" value="{matchtype}"></div>
        <div class="input-group"><label>placement</label><input type="text" id="g_placement" value="{placement}"></div>
        <div class="input-group"><label>device</label><input type="text" id="g_device" value="{device}"></div>
      </div>
    </div>

    <!-- Meta Ads Inputs -->
    <div id="metaTemplate" class="template-container">
      <div class="template-grid">
        <div class="input-group"><label>campaign_id</label><input type="text" id="m_campaignid" value="{{campaign.id}}">
        </div>
        <div class="input-group"><label>campaign_name</label><input type="text" id="m_campaignname"
            value="{{campaign.name}}"></div>
        <div class="input-group"><label>adset_id</label><input type="text" id="m_adsetid" value="{{adset.id}}"></div>
        <div class="input-group"><label>adset_name</label><input type="text" id="m_adsetname" value="{{adset.name}}">
        </div>
        <div class="input-group"><label>ad_id</label><input type="text" id="m_adid" value="{{ad.id}}"></div>
        <div class="input-group"><label>ad_name</label><input type="text" id="m_adname" value="{{ad.name}}"></div>
        <div class="input-group"><label>site_source</label><input type="text" id="m_sitesource"
            value="{{site_source_name}}"></div>
        <div class="input-group"><label>placement</label><input type="text" id="m_placement" value="{{placement}}">
        </div>
      </div>
    </div>
  </div>

  <div class="button-group">
    <button class="primary-btn" id="generateBtn" onclick="startGeneration()">Generate URLs</button>
    <button class="secondary-btn" id="cancelBtn" onclick="cancelGeneration()" disabled>Cancel</button>
  </div>

  <div id="progress-container">
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressBar"></div>
    </div>
    <div id="status">Processing...</div>
  </div>

  <script>
    let isCancelled = false;

    function startGeneration() {
      const source = document.getElementById('utmSource').value.trim();
      const medium = document.getElementById('utmMedium').value.trim();
      const campaign = document.getElementById('utmCampaign').value.trim();
      const term = document.getElementById('utmTerm').value.trim();
      const content = document.getElementById('utmContent').value.trim();
      const mode = document.querySelector('input[name="genMode"]:checked').value;
      const platform = document.getElementById('platformSelect').value;

      // Collect template variables based on platform
      let templateVars = {};
      if (platform === 'google') {
        templateVars = {
          campaignid: document.getElementById('g_campaignid').value.trim(),
          adgroupid: document.getElementById('g_adgroupid').value.trim(),
          creative: document.getElementById('g_creative').value.trim(),
          keyword: document.getElementById('g_keyword').value.trim(),
          matchtype: document.getElementById('g_matchtype').value.trim(),
          placement: document.getElementById('g_placement').value.trim(),
          device: document.getElementById('g_device').value.trim()
        };
      } else if (platform === 'meta') {
        templateVars = {
          campaign_id: document.getElementById('m_campaignid').value.trim(),
          campaign_name: document.getElementById('m_campaignname').value.trim(),
          adset_id: document.getElementById('m_adsetid').value.trim(),
          adset_name: document.getElementById('m_adsetname').value.trim(),
          ad_id: document.getElementById('m_adid').value.trim(),
          ad_name: document.getElementById('m_adname').value.trim(),
          site_source_name: document.getElementById('m_sitesource').value.trim(),
          placement: document.getElementById('m_placement').value.trim()
        };
      }

      const statusEl = document.getElementById('status');
      const progressContainer = document.getElementById('progress-container');

      if (mode !== 'short' && (!source || !medium || !campaign)) {
        progressContainer.style.display = 'block';
        statusEl.innerHTML = 'Source, Medium, and Campaign are required for UTM tags.';
        statusEl.className = 'error-text';
        return;
      }

      isCancelled = false;
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('cancelBtn').disabled = false;
      progressContainer.style.display = 'block';
      statusEl.className = '';
      updateProgress(0, 'Initializing...');

      const options = { source, medium, campaign, term, content, mode, templateVars };

      // Start the first chunk
      processChunk(options, null); // Start based on active selection
    }

    function processChunk(options, startRow) {
      if (isCancelled) {
        updateProgress(0, 'Cancelled by user.');
        document.getElementById('status').className = 'error-text';
        resetButtons();
        return;
      }

      updateProgress(null, `Processing from row ${startRow}...`);

      google.script.run
        .withSuccessHandler(function (result) {
          if (result.status === 'error') {
            updateProgress(0, result.message);
            document.getElementById('status').className = 'error-text';
            resetButtons();
          } else if (result.status === 'success') {
            updateProgress(100, result.message);
            document.getElementById('status').className = 'success-text';
            resetButtons();
          } else if (result.status === 'partial') {
            // Update progress bar
            const rangeInfo = result.options.rangeInfo;
            const total = rangeInfo.endRow - rangeInfo.startRow + 1;
            const current = result.currentRow - rangeInfo.startRow + 1;
            const percentage = Math.round((current / total) * 100);
            updateProgress(percentage, `Processed up to row ${result.currentRow}...`);

            // Trigger next chunk
            processChunk(result.options, result.nextRow);
          }
        })
        .withFailureHandler(function (error) {
          updateProgress(0, 'An unexpected error occurred: ' + error.message);
          document.getElementById('status').className = 'error-text';
          resetButtons();
        })
        .generateUrlsChunked(options, startRow);
    }

    function cancelGeneration() {
      isCancelled = true;
      document.getElementById('cancelBtn').disabled = true;
      document.getElementById('status').innerHTML = 'Cancelling...';
    }

    function updateProgress(percent, text) {
      if (percent !== null) {
        document.getElementById('progressBar').style.width = percent + '%';
      }
      document.getElementById('status').innerText = text;
    }

    function resetButtons() {
      document.getElementById('generateBtn').disabled = false;
      document.getElementById('cancelBtn').disabled = true;
    }

    // --- Advanced Tracking Logic ---

    function toggleAdvanced() {
      const panel = document.getElementById('advancedPanel');
      const icon = document.getElementById('advancedIcon');

      if (panel.classList.contains('active')) {
        panel.classList.remove('active');
        icon.style.transform = 'rotate(0deg)';
      } else {
        panel.classList.add('active');
        icon.style.transform = 'rotate(90deg)';
        updateTemplates();
      }
    }

    function updateTemplates() {
      const platform = document.getElementById('platformSelect').value;
      const tGoogle = document.getElementById('googleTemplate');
      const tMeta = document.getElementById('metaTemplate');

      tGoogle.classList.remove('active');
      tMeta.classList.remove('active');

      if (platform === 'google') {
        tGoogle.classList.add('active');
      } else if (platform === 'meta') {
        tMeta.classList.add('active');
      }
    }
  </script>
</body>

</html>